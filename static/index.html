<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ifarma BE Study Planner</title>
    <style>
        :root {
            --primary: #ff7a18;
            --primary-dark: #a445b2;
            --accent: #ff3cac;
            --bg: #0f0b1f;
            --card-bg: rgba(24, 18, 45, 0.82);
            --text: #f7ecff;
            --text-secondary: #ccb9e3;
            --border: #4d3b66;
            --success: #35d07f;
            --warning: #ffb84d;
            --error: #ff7a88;
            --info: #b191ff;
            --input-bg: rgba(18, 13, 36, 0.86);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(120deg, #140a27, #1f0f35, #2a143a, #140a27);
            background-size: 300% 300%;
            color: var(--text);
            line-height: 1.55;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            animation: bgShift 16s ease infinite;
        }
        body::before, body::after {
            content: "";
            position: fixed;
            z-index: -1;
            width: 340px;
            height: 340px;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.35;
            pointer-events: none;
            animation: drift 14s ease-in-out infinite;
        }
        body::before {
            background: #ff5f6d;
            top: -80px;
            left: -120px;
        }
        body::after {
            background: #7f5dff;
            right: -90px;
            bottom: -120px;
            animation-delay: 4s;
        }
        header {
            background: linear-gradient(130deg, #2d163d 0%, var(--primary-dark) 42%, var(--primary) 100%);
            color: #fff;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(7, 3, 17, 0.6);
            border-bottom-left-radius: 26px;
            border-bottom-right-radius: 26px;
        }
        header h1 { font-size: 1.75rem; font-weight: 700; letter-spacing: 0.2px; }
        header p { opacity: 0.9; font-size: 1rem; margin-top: 8px; max-width: 760px; }
        .container { max-width: 980px; margin: 0 auto; padding: 24px 16px 36px; position: relative; z-index: 1; }
        .steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 18px;
            list-style: none;
            padding-left: 0;
        }
        .step {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 12px;
            padding: 10px 12px;
            color: #f2d8ff;
            font-size: 0.84rem;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.2px;
            animation: riseIn 0.6s ease both;
        }
        .step:nth-child(2) { animation-delay: 0.08s; }
        .step:nth-child(3) { animation-delay: 0.16s; }
        .step-current {
            background: linear-gradient(120deg, rgba(255,122,24,0.22), rgba(164,69,178,0.2));
            border-color: rgba(255, 122, 24, 0.4);
            box-shadow: 0 0 0 1px rgba(255, 122, 24, 0.28), 0 0 20px rgba(255, 60, 172, 0.25);
        }
        .card {
            background: var(--card-bg);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.13);
            box-shadow: 0 14px 34px rgba(8, 4, 20, 0.5);
            backdrop-filter: blur(10px);
            padding: 26px 28px;
            margin-bottom: 18px;
            animation: riseIn 0.55s ease both;
            transition: transform 0.22s ease, box-shadow 0.22s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 42px rgba(8, 4, 20, 0.62);
        }
        .card h2 {
            font-size: 1.08rem;
            font-weight: 700;
            color: #ffdcb3;
            margin-bottom: 6px;
        }
        .section-lead {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 18px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px 18px;
        }
        .form-group { display: flex; flex-direction: column; }
        label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.35px;
        }
        label .hint {
            font-weight: 500;
            font-size: 0.75rem;
            color: var(--text);
            text-transform: none;
            letter-spacing: 0;
        }
        input, select {
            padding: 12px 13px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--input-bg);
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.16s;
            color: var(--text);
        }
        input::placeholder { color: var(--text); opacity: 0.62; }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 122, 24, 0.32), 0 0 18px rgba(255, 60, 172, 0.24);
            transform: translateY(-1px);
        }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 10px;
            padding-top: 24px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px; height: 18px; accent-color: var(--primary);
        }
        .checkbox-group label {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: var(--text);
            text-transform: none;
            letter-spacing: 0;
        }
        .btn-row { text-align: center; margin-top: 2px; }
        .btn-submit {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(120deg, #8e2de2, #ff512f, #dd2476);
            background-size: 220% 220%;
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 13px 38px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 14px 26px rgba(103, 43, 123, 0.44);
            transition: transform 0.14s, box-shadow 0.2s, filter 0.2s;
            position: relative;
            overflow: hidden;
            animation: bgShift 8s ease infinite;
        }
        .btn-submit::after {
            content: "";
            position: absolute;
            top: -150%;
            left: -35%;
            width: 30%;
            height: 400%;
            background: rgba(255, 255, 255, 0.24);
            transform: rotate(25deg);
            animation: shine 3.2s ease-in-out infinite;
            pointer-events: none;
        }
        .btn-submit:hover { transform: translateY(-1px); filter: brightness(1.06); }
        .btn-submit:active { transform: scale(0.99); }
        .btn-submit:disabled {
            background: linear-gradient(120deg, #665979, #827297);
            box-shadow: none;
            cursor: not-allowed;
            animation: none;
        }
        .spinner {
            display: none;
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.32);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #results { display: none; margin-top: 20px; }
        .result-section { margin-bottom: 14px; }
        table.pk-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        table.pk-table th, table.pk-table td {
            padding: 10px 12px;
            border: 1px solid var(--border);
            text-align: left;
        }
        table.pk-table th {
            background: rgba(255, 255, 255, 0.06);
            font-weight: 600;
        }
        .tag {
            display: inline-block;
            padding: 3px 9px;
            border-radius: 999px;
            font-size: 0.76rem;
            font-weight: 700;
            margin-right: 6px;
        }
        .tag-info { background: rgba(177, 145, 255, 0.2); color: #ceb5ff; }
        .tag-warning { background: rgba(255, 184, 77, 0.18); color: #ffd39a; }
        .tag-error { background: rgba(255, 122, 136, 0.18); color: #ffb5bd; }
        .issue-item {
            padding: 10px 12px;
            margin-bottom: 7px;
            border-radius: 8px;
            border-left: 4px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            font-size: 0.9rem;
        }
        .issue-item.info { border-left-color: var(--info); }
        .issue-item.warning { border-left-color: var(--warning); }
        .issue-item.error { border-left-color: var(--error); }
        .synopsis-box {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 18px;
            font-size: 0.88rem;
            line-height: 1.65;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        .error-box {
            background: rgba(255, 122, 136, 0.15);
            border: 1px solid var(--error);
            border-radius: 10px;
            padding: 14px 18px;
            color: var(--error);
            font-size: 0.92rem;
        }
        .no-issues { color: var(--success); font-weight: 600; }
        @keyframes bgShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes drift {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(24px, -18px); }
        }
        @keyframes riseIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shine {
            0%, 25% { left: -35%; }
            55%, 100% { left: 125%; }
        }
        @media (max-width: 760px) {
            .steps { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .card { padding: 18px 16px; }
            header { padding: 20px 16px; border-radius: 0 0 20px 20px; }
            header h1 { font-size: 1.42rem; }
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation: none !important; transition: none !important; }
        }
    </style>
</head>
<body>

<header>
    <h1>üíä Ifarma BE Study Planner</h1>
    <p>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –±–∏–æ—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ ‚Äî –≤–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</p>
</header>

<div class="container">
    <ol class="steps" aria-label="–®–∞–≥–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã">
        <li class="step step-current" aria-current="step">–®–∞–≥ 1 ¬∑ –ü—Ä–µ–ø–∞—Ä–∞—Ç</li>
        <li class="step">–®–∞–≥ 2 ¬∑ –î–∏–∑–∞–π–Ω –∏ –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</li>
        <li class="step">–®–∞–≥ 3 ¬∑ –ü–æ–ø—É–ª—è—Ü–∏—è</li>
    </ol>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <form id="studyForm" novalidate>

        <!-- Drug Information -->
        <div class="card">
            <h2>üß™ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–ø–∞—Ä–∞—Ç–µ</h2>
            <p class="section-lead">–£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–≥–æ —Ñ–∞—Ä–º–ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –∏ —Ä–µ–∂–∏–º –µ–≥–æ –ø—Ä–∏—ë–º–∞.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="inn">–ú–ù–ù (INN) –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞ <span class="hint">*</span></label>
                    <input type="text" id="inn" name="inn" required
                           placeholder="–Ω–∞–ø—Ä. –æ–º–µ–ø—Ä–∞–∑–æ–ª" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="dose_mg">–î–æ–∑–∏—Ä–æ–≤–∫–∞, –º–≥ <span class="hint">*</span></label>
                    <input type="number" id="dose_mg" name="dose_mg" required
                           min="0.01" step="any" placeholder="–Ω–∞–ø—Ä. 20">
                </div>
                <div class="form-group">
                    <label for="form">–õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞</label>
                    <select id="form" name="form">
                        <option value="tablet">–¢–∞–±–ª–µ—Ç–∫–∞</option>
                        <option value="capsule">–ö–∞–ø—Å—É–ª–∞</option>
                        <option value="solution">–†–∞—Å—Ç–≤–æ—Ä</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="regime">–†–µ–∂–∏–º –ø—Ä–∏—ë–º–∞</label>
                    <select id="regime" name="regime">
                        <option value="fasted">–ù–∞—Ç–æ—â–∞–∫</option>
                        <option value="fed">–ü–æ—Å–ª–µ –µ–¥—ã</option>
                        <option value="both">–û–±–∞</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Variability / Design -->
        <div class="card">
            <h2>üìä –í–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –¥–∏–∑–∞–π–Ω</h2>
            <p class="section-lead">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="cv_intra">CVintra <span class="hint">(0‚Äì1, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
                    <input type="number" id="cv_intra" name="cv_intra"
                           min="0" max="1" step="0.01" placeholder="–Ω–∞–ø—Ä. 0.25">
                </div>
                <div class="form-group">
                    <label for="cv_category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è CVintra <span class="hint">(–µ—Å–ª–∏ —á–∏—Å–ª–æ –Ω–µ –∑–∞–¥–∞–Ω–æ)</span></label>
                    <select id="cv_category" name="cv_category">
                        <option value="">‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                        <option value="low">–ù–∏–∑–∫–∞—è (low)</option>
                        <option value="high">–í—ã—Å–æ–∫–∞—è (high)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="study_type">–¢–∏–ø –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</label>
                    <select id="study_type" name="study_type">
                        <option value="single">–û–¥–Ω–æ—Ñ–∞–∑–Ω–æ–µ</option>
                        <option value="two_stage">–î–≤—É—Ö—Ñ–∞–∑–Ω–æ–µ (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="preferred_design">–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω <span class="hint">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
                    <input type="text" id="preferred_design" name="preferred_design"
                           placeholder="–Ω–∞–ø—Ä. 2x2">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="need_rsabe" name="need_rsabe">
                    <label for="need_rsabe">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è RSABE</label>
                </div>
            </div>
        </div>

        <!-- Population -->
        <div class="card">
            <h2>üë• –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ø—É–ª—è—Ü–∏–∏ –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–µ–≤</h2>
            <p class="section-lead">–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞, –ø–æ–ª–∞ –∏ –ò–ú–¢ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="min_age">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç <span class="hint">(‚â• 18)</span></label>
                    <input type="number" id="min_age" name="min_age"
                           value="18" min="18" max="65">
                </div>
                <div class="form-group">
                    <label for="max_age">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç <span class="hint">(‚â§ 65)</span></label>
                    <input type="number" id="max_age" name="max_age"
                           value="55" min="18" max="65">
                </div>
                <div class="form-group">
                    <label for="sex">–ü–æ–ª –¥–æ–±—Ä–æ–≤–æ–ª—å—Ü–µ–≤</label>
                    <select id="sex" name="sex">
                        <option value="both">–ú—É–∂—Å–∫–æ–π –∏ –∂–µ–Ω—Å–∫–∏–π</option>
                        <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                        <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                    </select>
                </div>
                <div class="form-group" style="visibility:hidden">
                    <!-- spacer for grid alignment -->
                </div>
                <div class="form-group">
                    <label for="bmi_min">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ò–ú–¢</label>
                    <input type="number" id="bmi_min" name="bmi_min"
                           value="18.5" min="10" max="50" step="0.1">
                </div>
                <div class="form-group">
                    <label for="bmi_max">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ò–ú–¢</label>
                    <input type="number" id="bmi_max" name="bmi_max"
                           value="30.0" min="10" max="60" step="0.1">
                </div>
            </div>
        </div>

        <div class="btn-row">
            <button type="submit" class="btn-submit" id="submitBtn">
                <span id="btnText">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</span>
                <span class="spinner" id="spinner"></span>
            </button>
        </div>
    </form>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="results">

        <!-- Error -->
        <div id="errorBox" class="error-box" style="display:none;margin-bottom:20px;"></div>

        <!-- PK Parameters -->
        <div class="card result-section" id="resPK">
            <h2>üìà –§–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
            <table class="pk-table">
                <thead>
                    <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
                </thead>
                <tbody id="pkBody"></tbody>
            </table>
        </div>

        <!-- Design -->
        <div class="card result-section" id="resDesign">
            <h2>üî¨ –í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h2>
            <div id="designDetails"></div>
        </div>

        <!-- Sample Size -->
        <div class="card result-section" id="resSample">
            <h2>üî¢ –†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏</h2>
            <div id="sampleDetails"></div>
        </div>

        <!-- Regulatory Issues -->
        <div class="card result-section" id="resIssues">
            <h2>‚ö†Ô∏è –†–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è</h2>
            <div id="issuesList"></div>
        </div>

        <!-- Synopsis -->
        <div class="card result-section" id="resSynopsis">
            <h2>üìù –°–∏–Ω–æ–ø—Å–∏—Å –ø—Ä–æ—Ç–æ–∫–æ–ª–∞</h2>
            <div class="synopsis-box" id="synopsisContent"></div>
        </div>
    </div>

</div>

<script>
document.getElementById('studyForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('submitBtn');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btnText');
    const resultsDiv = document.getElementById('results');
    const errorBox = document.getElementById('errorBox');

    // Build payload
    const payload = {
        inn: document.getElementById('inn').value.trim(),
        dose_mg: parseFloat(document.getElementById('dose_mg').value),
        form: document.getElementById('form').value,
        regime: document.getElementById('regime').value,
        study_type: document.getElementById('study_type').value,
        min_age: parseInt(document.getElementById('min_age').value, 10),
        max_age: parseInt(document.getElementById('max_age').value, 10),
        sex: document.getElementById('sex').value,
        bmi_min: parseFloat(document.getElementById('bmi_min').value),
        bmi_max: parseFloat(document.getElementById('bmi_max').value),
    };

    // Optional fields
    const cvVal = document.getElementById('cv_intra').value;
    if (cvVal !== '') payload.cv_intra = parseFloat(cvVal);

    const cvCat = document.getElementById('cv_category').value;
    if (cvCat !== '') payload.cv_category = cvCat;

    const prefDesign = document.getElementById('preferred_design').value.trim();
    if (prefDesign !== '') payload.preferred_design = prefDesign;

    if (document.getElementById('need_rsabe').checked) {
        payload.need_rsabe = true;
    }

    // Validate required
    if (!payload.inn || isNaN(payload.dose_mg) || payload.dose_mg <= 0) {
        errorBox.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ú–ù–ù –∏ –¥–æ–∑–∏—Ä–æ–≤–∫–∞ (> 0).';
        errorBox.style.display = 'block';
        resultsDiv.style.display = 'block';
        document.getElementById('resPK').style.display = 'none';
        document.getElementById('resDesign').style.display = 'none';
        document.getElementById('resSample').style.display = 'none';
        document.getElementById('resIssues').style.display = 'none';
        document.getElementById('resSynopsis').style.display = 'none';
        return;
    }

    // Show spinner
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    btnText.textContent = '–†–∞—Å—á—ë—Ç‚Ä¶';
    errorBox.style.display = 'none';

    try {
        const resp = await fetch('/design', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });

        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status}`);
        }

        const data = await resp.json();
        renderResults(data);

    } catch (err) {
        errorBox.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
        errorBox.style.display = 'block';
        resultsDiv.style.display = 'block';
        document.getElementById('resPK').style.display = 'none';
        document.getElementById('resDesign').style.display = 'none';
        document.getElementById('resSample').style.display = 'none';
        document.getElementById('resIssues').style.display = 'none';
        document.getElementById('resSynopsis').style.display = 'none';
    } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
        btnText.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è';
    }
});

function renderResults(data) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    document.getElementById('errorBox').style.display = 'none';
    document.getElementById('resPK').style.display = '';
    document.getElementById('resDesign').style.display = '';
    document.getElementById('resSample').style.display = '';
    document.getElementById('resIssues').style.display = '';
    document.getElementById('resSynopsis').style.display = '';

    // PK table
    const pk = data.pk;
    const pkRows = [
        ['Cmax (–Ω–≥/–º–ª)', pk.cmax],
        ['AUC (–Ω–≥¬∑—á/–º–ª)', pk.auc],
        ['Tmax (—á)', pk.tmax],
        ['T¬Ω (—á)', pk.t_half],
        ['CVintra', pk.cv_intra],
    ];
    document.getElementById('pkBody').innerHTML = pkRows.map(([p, v]) =>
        `<tr><td>${p}</td><td>${v != null ? v : '‚Äî'}</td></tr>`
    ).join('');

    // Design
    const d = data.design;
    document.getElementById('designDetails').innerHTML = `
        <table class="pk-table">
            <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><td>${d.name}</td></tr>
            <tr><th>–¢–∏–ø</th><td>${d.type}</td></tr>
            <tr><th>–ü–µ—Ä–∏–æ–¥—ã</th><td>${d.periods}</td></tr>
            <tr><th>–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</th><td>${d.sequences.join(', ')}</td></tr>
            <tr><th>Wash-out (–¥–Ω–∏)</th><td>${d.washout_days}</td></tr>
            <tr><th>RSABE</th><td>${d.rsabe_applicable ? '–î–∞' : '–ù–µ—Ç'}</td></tr>
        </table>
    `;

    // Sample size
    const s = data.sample_size;
    document.getElementById('sampleDetails').innerHTML = `
        <table class="pk-table">
            <tr><th>–ë–∞–∑–æ–≤—ã–π N</th><td>${s.base_n}</td></tr>
            <tr><th>N —Å —É—á—ë—Ç–æ–º –ø–æ—Ç–µ—Ä—å</th><td>${s.adjusted_for_dropout}</td></tr>
            <tr><th>Drop-out rate</th><td>${(s.dropout_rate * 100).toFixed(0)}%</td></tr>
            <tr><th>Screen-fail rate</th><td>${(s.screen_fail_rate * 100).toFixed(0)}%</td></tr>
        </table>
    `;

    // Issues
    const issuesDiv = document.getElementById('issuesList');
    if (data.issues.length === 0) {
        issuesDiv.innerHTML = '<p class="no-issues">‚úÖ –ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ—Ç.</p>';
    } else {
        issuesDiv.innerHTML = data.issues.map(iss => {
            const tagClass = 'tag-' + iss.severity;
            return `<div class="issue-item ${iss.severity}">
                <span class="tag ${tagClass}">${iss.severity.toUpperCase()}</span>
                <strong>[${iss.code}]</strong> ${iss.message}
            </div>`;
        }).join('');
    }

    // Synopsis
    document.getElementById('synopsisContent').textContent = data.synopsis_md;

    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>

</body>
</html>
